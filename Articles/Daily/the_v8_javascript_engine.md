## The V8 JavaScript Engine

원문: [The V8 JavaScript Engine](https://medium.com/@manikmudholkar831995/the-v8-javascript-engine-d1434ca77c96)

자바스크립트는 동적 타임 인터프리터이고 프로그램을 실행시키기 위해 V8엔진을 이용하여 바이트 코드를 생성한다.

### V8이란?

V8엔진은 구글에서 개발된 C++로 개발된 오픈 소스 고성능 자바스크립트, 웹 어셈플리 엔진이며 크롬과 Node.js에서 사용중

spidermonkey

-   JS > bytecodes > machine code

V8

-   JS > machine code

### Node.js에서 어떻게 사용되나?

V8에서 객체, JSON, date와 같은 구현체는 발견할 수 있지만 document 객체나 `require()`같은 것은 c++로 작성 후 V8을 통해 JS 함수로 바인딩함

-   c/cpp은 low level 언어라 더 강력한 힘과 접근권을 가짐

### V8 동작법

두 가지 방식으로 코드를 컴파일함

1. 최적화 코드는 아니지만 빠르고 충분히 실행시킬 수 있을 정도로 컴파일.
2. 그 동안 background에서 느리지만 최적화된 방식으로 컴파일
3. 최적화가 완료되면 자바스크립트는 기존 컴파일 코드에서 최적화 코드로 변경

4. `Ignition`: 빠른 인터프리터
    - AST와 bytecode를 생성
5. `Turbofan`: 최적화 컴파일러
    - 자주 사용되는 함수가 있으면 최적화
6. `JIT`: Just In Time, 실행 도중 코드 성격을 분석하여 머신코드로 컴파일
    - V8에서는 Ignition + Turbofan 조합을 의미

Flow

1.  V8이 코드를 보고 AST로 변경 (스코프 생성)

-   AST(Abstract Syntax Tree): 소스코드를 구조적으로 분석한 트리 형태 표현

2.  Ignition 인터프리터는 AST와 스코프를 통해 bytecode 생성
3.  엔진은 코드를 실행시키고 타입 피드백을 수집
    -   Type Feedback: 실제로 사용된 데이터 타입 정보를 수집
    -   자바스크립트는 동적 타입 언어라 실행 중 타입을 관찰하여 자주 사용되는 타입 정보들을 수집하고 이를 통해 최적화가 가능
4.  피드백 테이터와 함께 최적화 컴파일러에게 바이트 코드가 전달되고 이를 통해 최적화된 머신 코드를 생성함.
    -   `hot code`: 자주 사용되는 바이트 코드이며 이를 통해 효율적인 머신 코드로 변환함
    -   해당 작업은 병렬적으로 처리됨.

왜 바이트코드 대신 머신코드를 바로 사용하지 않는가?

1. 머신코드는 많은 메모리가 소모된다
2. 머신코드는 항상 바이트코드보다 빠른 건 않다.
    - 실행 시간에 있어 적은 속도를 가지더라도 컴파일 시간이 오래 걸림
    - 바이트 코드는 컴파일 시간이 빠른 대신 실행 단계가 느림
3. 가끔 잘못된 추정이 나오면, 최적화 컴파일러는 최적화를 해제하고 인터프리터로 다시 돌아감
